service routing protocols model multi-agent

username admin privilege 15 secret arista-admin
enable password arista-admin

ip routing

lldp run

{% for host_item in host %}
hostname {{ host[host_item].name }}

interface loopback0
 ip address {{ host[host_item].loopback }}

{% if 'leaf' in host[host_item].name %}
interface loopback1
 ip address {{ vxlan_ip }}
 description VXLAN Source

vlan 4093
name MLAG-iBGP-PEER

interface vlan4093
 ip address {{ mlag }}

ip prefix-list LOOPBACKS
 permit {{ vxlan_ip }}
 permit {{ host[host_item].loopback }}
{% elif 'spine' in host[host_item].name %}
ip prefix-list LOOPBACKS
 permit {{ host[host_item].loopback }}
{% endif %}
{% endfor %}
ip prefix-list P2P-UNDERLAY
 permit 0.0.0.0/0 eq 31

{% for intf_item in intf %}
interface {{ intf[intf_item].name }}
 no switchport
 ip address {{ intf[intf_item].local_ip }}
 description Connection to {{ intf[intf_item].z_host }}:{{ intf[intf_item].z_port }}
 mtu 9214
 no shutdown
{% endfor %}

route-map LOCAL-PREFIX permit 10
 match ip address prefix-list LOOPBACKS

route-map LOCAL-PREFIX permit 20
 match ip address prefix-list P2P-UNDERLAY

{% for host_item in host %}
{% if 'spine' in host[host_item].name %}
router bgp 65520
 router-id {{ host[host_item].loopback[:-3] }}
 no bgp default ipv4-unicast
 neighbor LEAF-UNDERLAY peer group
 neighbor LEAF-UNDERLAY remote-as 65530
 neighbor LEAF-UNDERLAY send-community
 neighbor LEAF-UNDERLAY maximum-routes 1000
 {% for intf_item in intf %}
 neighbor {{ intf[intf_item].z_ip[:-3] }} peer group LEAF-UNDERLAY
 neighbor {{ intf[intf_item].z_ip[:-3] }} description {{ intf[intf_item].z_host }}{% endfor %}
 redistribute connected route-map LOCAL-PREFIX

 address-family ipv4
  neighbor LEAF-UNDERLAY activate
{% elif 'leaf' in host[host_item].name %}
router bgp 65530
 router-id {{ host[host_item].loopback[:-3] }}
 no bgp default ipv4-unicast
 maximum-paths 2
 neighbor SPINE-UNDERLAY peer group
 neighbor SPINE-UNDERLAY remote-as 65520
 neighbor SPINE-UNDERLAY allowas-in
 neighbor SPINE-UNDERLAY send-community
 neighbor SPINE-UNDERLAY maximum-routes 1000
 neighbor MLAG-UNDERLAY peer group
 neighbor MLAG-UNDERLAY remote-as 65530
 neighbor MLAG-UNDERLAY next-hop-self
 neighbor MLAG-UNDERLAY send-community
 neighbor MLAG-UNDERLAY maximum-routes 1000
 {% for intf_item in intf %}
 neighbor {{ intf[intf_item].z_ip[:-3] }} peer group SPINE-UNDERLAY
 neighbor {{ intf[intf_item].z_ip[:-3] }} description {{ intf[intf_item].z_host }}{% endfor %}
 neighbor {{ mlag_neigh }} peer group MLAG-UNDERLAY
 redistribute connected route-map LOCAL-PREFIX

 address-family ipv4
  neighbor SPINE-UNDERLAY activate
  neighbor MLAG-UNDERLAY activate
{% endif %}
{% endfor %}
